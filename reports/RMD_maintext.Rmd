---
title: "Phosphorus analysis"
author: "Laure Olazcuaga, Nicolas Rode"
date: "`r format(Sys.Date(), '%d-%B-%Y')`"
output: 
  html_document:
    theme: "journal"
    toc: true
    toc_depth: 3
    number_sections: true
    toc_float:
      collapsed: false
      smooth_scroll: false
editor_options: 
  chunk_output_type: console
---


```{r setup, include =FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
devtools::load_all()
```


# DATA
## Color fruits
```{r }

data_color <- read.table(file=here::here("data", "Data_color_fruits.csv"), sep=",", header=TRUE)
head(data_color)

data_color$hex_code <- paste0("#",data_color$hex)

rgba_array <- col2rgb(data_color$hex_code, alpha=TRUE )
data_color$red <- rgba.array[1,]
data_color$green <- rgba.array[2,]
data_color$blue <- rgba.array[3,]

hcl_array <- as(colorspace::hex2RGB(data_color$hex_code), "polarLUV")
S4_to_dataframe <- function(s4obj) {
  nms <- slotNames(s4obj)
  lst <- lapply(nms, function(nm) slot(s4obj, nm))
  as.data.frame(setNames(lst, nms))
}
hcl_array_clean <- S4_to_dataframe(hcl_array)

data_color$luminance <- hcl_array_clean[,1] #(whether a color is light or dark)
data_color$chroma <- hcl_array_clean[,2] #how colorful the color is compared to a gray with the same
data_color$hue <- hcl_array_clean[,3]


rm(hcl_array,rgba_array, hcl_array)

head(data_color)

```

## Preference data
```{r }
data_phosphorus  <- read.table(file=here::here("data", "DATA_PHOSPHORUS_test_arenas.csv"), sep=",", header=TRUE)
data_control  <- read.table(file=here::here("data", "DATA_FRUITS_control_arenas.csv"), sep=",", header=TRUE)

# Verification des donnees
str(data_phosphorus)
str(data_control)

data_phosphorus$obs <- as.factor(1:nrow(data_phosphorus))
data_control$obs <- as.factor(1:nrow(data_control))
```



## Composition fruits
```{r }
data_compo  <- read.table(file=here::here("data", "Data_compo_fruits_FromOlazcuaga2019.csv"),
                               sep=",", header=TRUE)

data_compo$Phosphorus <- data_compo$Phosphorus/1000

data_compo_clean <- data.frame(Fruit = data_compo$Treatment, 
                         Concentration = data_compo$Phosphorus)

```


## Merge dataset
```{r }

data_control <- merge(data_control, data_compo_clean, 
      by.x = "Fruit",  by.y = "Fruit", all.x = TRUE, all.y = FALSE)

data_color <- merge(data_color, data_compo_clean, 
      by.x = "fruit",  by.y = "Fruit", all.x = TRUE, all.y = FALSE)


```




# ANALYSIS
## Phosphore standard vs control
```{r }

#Phosphorus effect
lm0 <- lme4::glmer(Nb_eggs ~ Concentration + (1|ArenaID) + (1|Row:Column) + (1|obs), 
             data = data_phosphorus, family = poisson(link = "log"))
lm1 <- lme4::glmer(Nb_eggs ~ 1 + (1|ArenaID) + (1|Row:Column) + (1|obs), 
             data = data_phosphorus, family = poisson(link = "log"))
anova(lm0,lm1,test="Chisq")


#Control treatment
lm0 <- lme4::glmer(Nb_eggs ~ Concentration + (1|ArenaID) + (1|Row:Column) + (1|obs), 
             data = data_control, family = poisson(link = "log"))
lm1 <- lme4::glmer(Nb_eggs ~ 1 + (1|ArenaID) + (1|Row:Column) + (1|obs), 
             data = data_control, family = poisson(link = "log"))
anova(lm0,lm1,test="Chisq")



```


# PLOT
```{r }
SUM_Phosphore <- Rmisc::summarySE(data_phosphorus, 
                        measurevar = c("Nb_eggs"),
                       groupvars = c("Concentration"), 
                       na.rm=TRUE)

PLOT_Phosphorus_average <- ggplot2::ggplot(data_phosphorus, aes(x = Concentration, y = Nb_eggs)) + 
  geom_point(data = SUM_Phosphore, aes(x = Concentration, y = Nb_eggs), 
             size = 5, position = position_dodge(0.8)) +
  geom_errorbar(data = SUM_Phosphore, aes(x = Concentration,
                                          ymin = Nb_eggs-ci, ymax = Nb_eggs+ci,), 
             size = 1, width=.05,  position = position_dodge(0.4)) +
  geom_point(position = position_dodge(width = 0.7), size = 0.8, alpha = 0.6) +
    xlim(-0.05,1.7) +
  ylab("Number of eggs") +
  xlab("Phosphorus concentration") +
  theme_LO_sober
PLOT_Phosphorus_average


SUM_Control <- Rmisc::summarySE(data_control, 
                        measurevar = c("Nb_eggs"),
                       groupvars = c("Concentration",
                                     "Fruit"), 
                       na.rm=TRUE)


PLOT_Control_average <- ggplot2::ggplot(data_control, 
                                        aes(x = Concentration, y = Nb_eggs,
                                            color= Fruit)) + 
  geom_point(data = SUM_Control, aes(x = Concentration, y = Nb_eggs), 
             size = 5, position = position_dodge(0.8)) +
  geom_errorbar(data = SUM_Control, aes(x = Concentration,
                                          ymin = Nb_eggs-ci, ymax = Nb_eggs+ci,), 
             size = 1, width=.01,  position = position_dodge(0.2)) +
  geom_point(position = position_dodge(width = .05), size = 0.8, alpha = 0.6) +
  scale_color_manual(name="Fruit",
                     breaks = c("Tomato","Grape","Blackberry","Kiwi", "Raspberry", "Strawberry","Fig", "Rosehips", "Cherry","Blackcurrant", "Cranberry", "Apricot"), 
                    labels = c("Tomato","Grape","Blackberry","Kiwi", "Raspberry", "Strawberry","Fig", "Rosehips", "Cherry","Blackcurrant", "Cranberry", "Apricot"), 
                    values = c("#e31a1c","#b2df8a","#1f78b4","#33a02c", "#fdbf6f", "#fb9a99","#6a3d9a", "#b15928", "#cab2d6","#a6cee3", "#e7e700", "#ff7f00")) +
  xlim(-0.005,0.325) +
  ylab("Number of eggs") +
  xlab("Phosphorus concentration") +
  theme_LO_sober
PLOT_Control_average



```























# Plot color
```{r }

desc1 <- psych::describeBy(data_color$red, data_color$fruit, mat =TRUE, digits =2)
desc1 <- desc1[order(desc1$group1),]
desc2 <- psych::describeBy(data_control$Nb_eggs, data_control$Fruit , mat =TRUE, digits =2)
desc2 <- desc2[order(desc2$group1),]

COL_VECTOR <- c("Apricot" = "#ff7f00",  "Blackberry" = "#1f78b4", "Blackcurrant" = "#a6cee3", "Cherry" = "#cab2d6", "Cranberry" = "#e7e700", "Fig" = "#6a3d9a",  "Grape" = "#b2df8a","Kiwi" = "#33a02c","Raspberry" = "#fdbf6f","Rose hips" = "#b15928",  "Strawberry" = "#fb9a99", 
           "Tomato" = "#e31a1c")

cor_test <- cor.test(desc1$mean, desc2$mean)
title <- paste("P-value = ", cor_test$p.value)

cowplot::save_plot(file=here::here("figures", "Red_color.pdf"),
          psych::error.crosses(desc1, desc2,
              labels = desc1$group1,
              xlab = "Color: Red",
              ylab = "Number of eggs",
              offset = 2, las = 1,
              main = title,
              sd =F, 
              cex.lab= 1.5,
              cex.axis = 1.5,
              arrow.len = 0.01,
              color = COL_VECTOR,
              pch = 16,
              cex = 1.5),
         base_height = 20/cm(1), base_width = 20/cm(1), dpi = 1200)







###### Data
desc1 <- psych::describeBy(data_color$green, data_color$fruit, mat =TRUE, digits =2)
desc1 <- desc1[order(desc1$group1),]
cor_test <- cor.test(desc1$mean, desc2$mean)
title <- paste("P-value = ", cor_test$p.value)

cowplot::save_plot(file=here::here("figures", "Green_color.pdf"),
          psych::error.crosses(desc1, desc2,
              labels = desc1$group1,
              xlab = "Color: Green",
              ylab = "Number of eggs",
              offset = 2, las = 1,
              main = title,
              sd =F, 
              cex.lab= 1.5,
              cex.axis = 1.5,
              arrow.len = 0.01,
              color = COL_VECTOR,
              pch = 16,
              cex = 1.5),
         base_height = 20/cm(1), base_width = 20/cm(1), dpi = 1200)




###### Data
desc1 <- psych::describeBy(data_color$blue, data_color$fruit, mat =TRUE, digits =2)
desc1 <- desc1[order(desc1$group1),]
cor_test <- cor.test(desc1$mean, desc2$mean)
title <- paste("P-value = ", cor_test$p.value)

cowplot::save_plot(file=here::here("figures", "Blue_color.pdf"),
          psych::error.crosses(desc1, desc2,
              labels = desc1$group1,
              xlab = "Color: Blue",
              ylab = "Number of eggs",
              offset = 2, las = 1,
              main = title,
              sd =F, 
              cex.lab= 1.5,
              cex.axis = 1.5,
              arrow.len = 0.01,
              color = COL_VECTOR,
              pch = 16,
              cex = 1.5),
         base_height = 20/cm(1), base_width = 20/cm(1), dpi = 1200)






###### Data
desc1 <- psych::describeBy(data_color$luminance, data_color$fruit, mat =TRUE, digits =2)
desc1 <- desc1[order(desc1$group1),]
cor_test <- cor.test(desc1$mean, desc2$mean)
title <- paste("P-value = ", cor_test$p.value)

cowplot::save_plot(file=here::here("figures", "Luminance_color.pdf"),
          psych::error.crosses(desc1, desc2,
              labels = desc1$group1,
              xlab = "Color: Luminance",
              ylab = "Number of eggs",
              offset = 2, las = 1,
              main = title,
              sd =F, 
              cex.lab= 1.5,
              cex.axis = 1.5,
              arrow.len = 0.01,
              color = COL_VECTOR,
              pch = 16,
              cex = 1.5),
         base_height = 20/cm(1), base_width = 20/cm(1), dpi = 1200)





###### Data
desc1 <- psych::describeBy(data_color$chroma, data_color$fruit, mat =TRUE, digits =2)
desc1 <- desc1[order(desc1$group1),]
cor_test <- cor.test(desc1$mean, desc2$mean)
title <- paste("P-value = ", cor_test$p.value)

cowplot::save_plot(file=here::here("figures", "Chroma_color.pdf"),
          psych::error.crosses(desc1, desc2,
              labels = desc1$group1,
              xlab = "Color: Chroma",
              ylab = "Number of eggs",
              offset = 2, las = 1,
              main = title,
              sd =F, 
              cex.lab= 1.5,
              cex.axis = 1.5,
              arrow.len = 0.01,
              color = COL_VECTOR,
              pch = 16,
              cex = 1.5),
         base_height = 20/cm(1), base_width = 20/cm(1), dpi = 1200)



###### Data
desc1 <- psych::describeBy(data_color$hue, data_color$fruit, mat =TRUE, digits =2)
desc1 <- desc1[order(desc1$group1),]
cor_test <- cor.test(desc1$mean, desc2$mean)
title <- paste("P-value = ", cor_test$p.value)

cowplot::save_plot(file=here::here("figures", "Hue_color.pdf"),
          psych::error.crosses(desc1, desc2,
              labels = desc1$group1,
              xlab = "Color: Hue",
              ylab = "Number of eggs",
              offset = 2, las = 1,
              main = title,
              sd =F, 
              cex.lab= 1.5,
              cex.axis = 1.5,
              arrow.len = 0.01,
              color = COL_VECTOR,
              pch = 16,
              cex = 1.5),
         base_height = 20/cm(1), base_width = 20/cm(1), dpi = 1200)


```





























# OLD

# Plots

## Histogrammes du nombre d'oeuf par emplacement de boite de 12
```{r }
# histogram(~nb_oeufs|ligne*colonne, data=P, main="Nombre d'oeuf par emplacement, phosphore")
# histogram(~nb_oeufs|ligne*colonne, data=Fr, main="Nombre d'oeuf par emplacement, fruit")
```

## Nb_oeufs~concentration
```{r }
ggplot(P, aes(x=concentration, 
              y=nb_oeufs, group=concentration))+
  geom_boxplot(notch=F,aes(fill=concentration))+
  theme_LO_sober +
  ggtitle("Nombre de pontes en fonction de la concentration en phosphore du milieu")

```

On remarque ici que les moyennes de nombre de ponte en fonction de la concentration en phosphore restent sensiblement égales quelque soit la concentration en phosphore du milieu. 

## Nb_oeufs~fruit
```{r }
ggplot(Fr, aes(x=fruit, y=nb_oeufs, group=fruit))+geom_boxplot(notch=F,aes(fill=fruit))+theme_bw()+ggtitle("Nombre de pontes en fonction du fruit contenu dans le milieu")

fruit <- data.frame(tapply(Fr$nb_oeufs,Fr$fruit,mean))
fruit <- cbind(fruit, c("0.132","0.288","0.236","0","0.175","0.159","0.128","0.142","0.123","0.309","0.0506","0.107"))
fruit <- cbind(fruit, c("abricot","cassis","cerise","cranberry","eglantine","figue","fraise","framboise","kiwi","mure","raisin","tomate"))
colnames(fruit) <- c("mean","phosphorus", "fruits")
fruit$phosphorus <- as.numeric(as.character(fruit$phosphorus))

plot(fruit$mean~fruit$phosphorus, ylab="Mean egg number",xlab="phosphorus content in g/l", pch="", main="Moyennes des pontes dans les différents milieux fruit")
text(fruit$mean~fruit$phosphorus,labels=fruit$fruits)

```

On retrouve bien la tendance déjà découverte par Laure sur les fruits : les milieux de ponte préférés sont Cerise, Cassis et Mûre. On voit aussi que la Figue et la Framboise sont plus préférées que lors des tests précédents. Ces résultats prouvent que l'effet de préférence du phosphore dans les fruits peut êtrre détecté chez une lignée consanguine de laboratoire, comme chez une population sauvage. 

# Analyses stats.

## Phosphore 
### Test de corrélation nombre d'oeufs ~ concentration P
```{r}
cor.test(P$nb_oeufs, as.numeric(P$concentration), method="spearman")
```

### Concentrations
```{r }
concentration <- data.frame(tapply(P$nb_oeufs,P$concentration,mean, na.rm=T))
stdev <- tapply(P$nb_oeufs,P$concentration, sd, na.rm=T)
concentration <- cbind(concentration, c("0","0.15","0.3","0.45","0.6","0.75","0.9","1.05","1.2","1.35","1.5","1.65"))
colnames(concentration) <- c("mean","concentration")
ggplot(concentration, aes(x=concentration, y=mean))+geom_point()+ggtitle("Moyennes des pontes suivant la concentration du milieu en phosphore")
```

### GLM
```{r }
lm0 <- glmer(nb_oeufs~1+(1|boite)+(1|ligne:colonne) + (1|obs), data=P, family = poisson(link = "log"))
summary(lm0)
lm1 <- glmer(nb_oeufs~concentration+(1|boite)+(1|ligne:colonne) + (1|obs), data=P, family = poisson(link = "log"))
summary(lm1)
anova(lm0,lm1,test="Chisq")

P$concentrationsq <- P$concentration^2
lm2 <-  glmer(nb_oeufs~concentration+concentrationsq+(1|boite)+(1|ligne:colonne) + (1|obs), data=P, family = poisson(link = "log"))
summary(lm2)
anova(lm1,lm2,test="Chisq")
lm4 <- glm(nb_oeufs~ligne:colonne +boite, data=P, family = poisson(link = "log"))
P$resid <- residuals(lm4)

ggplot(P, aes(x=factor(concentration), col=factor(concentration), y=resid))+geom_boxplot()

```

Les résultats retrouvés ici sont inverses à ceux découverts avec les milieux fruits. Les milieux les pus concentrés en phosphore sont délaissés par les D.suzuki au profit des milieux les moins concentrés.

#### Effet de la position 
```{r }
lm4 <- glmer(nb_oeufs~(1|ligne:colonne)+(1|boite), data=P, family = poisson(link = "log"))
anova(lm0,lm4, test="Chisq")
ranef(lm4)
summary(lm4)
```

Il pourrait y avoir un effet d'autocorrélation spatiale à tester ici. 

### Pontes moyennes par position

```{r }
spatial_mean <-(tapply(P$nb_oeufs, list(colonne=P$colonne, ligne=P$ligne), mean))
spatial_mean_melted <- melt(spatial_mean)
hm.palette <- colorRampPalette(rev(brewer.pal(11, 'Spectral')), space='Lab')
ggplot(spatial_mean_melted, aes(x = colonne, y = ligne, fill = value)) + 
  geom_tile()+
  scale_fill_gradientn(colours = hm.palette(100))
```

Les moyennes de ontes sont largement plus élevées sur les lignes externes des boites et notamment dans les colonnes de gauche. 

### Modèles prenant en compte l'autocorrélation spatiale
```{r }
```

## Fruits

### Corrélation phosphore
```{r}
cor.test(fruit$mean, as.numeric(fruit$phosphorus), method="spearman")
```

On remarque une corrélation positive entre les moyennnes des pontes sur milieux fruit et leur concentration en phosphore. 

### GLM
```{r}

lm0 <- glmer(nb_oeufs~1+(1|boite), data=Fr, family = poisson(link = "log"))
lm1 <- glmer(nb_oeufs~fruit+(1|boite), data=Fr, family = poisson(link = "log"))
lm2 <- glm(nb_oeufs~fruit, data=Fr, family = poisson(link = "log"))

anova(lm0,lm1,test="Chisq")
anova(lm1,lm2,test="Chisq")
```
La tendance observée sur les boxplots des pontes sur milieux fruits est confirmée. Les fruits les plus concentrés en phosphore sont préférés par les D.suzuki. 

### Pontes moyennes par position

```{r }
spatial_mean_fr <-(tapply(Fr$nb_oeufs, list(colonne=Fr$colonne, ligne=Fr$ligne), mean))
spatial_mean_fr_melted <- melt(spatial_mean_fr)
ggplot(spatial_mean_fr_melted, aes(x = colonne, y = ligne, fill = value)) + 
  geom_tile()+
  scale_fill_gradientn(colours = hm.palette(100))
```

Pour les boîtes de fruit, on observe des pontes moyennes largement plus élevées dans le coin bas gauche des boîtes.  Il faudrait donc également essayer de fitter un modèle prenant en compte l'impact de la position des milieux sur les données fruits. 
On retrouve une moyenne de ponte élevée dans le coin bas gauche de boites de milieux phosphore et fruit. 

# Conclusion 
Plusieurs hypothèses restent à tester. Tout d'abord l'effet possible d'une autocorrélation spatiale. Pour tester  cette première hypothèse, il faudra créer un modèle la prenant en compte. 
Une autre possibilité pouvant expliquer l'effet négatif de la concentration en P sur le nombre de pontes est qu'il existe une molécule dans les milieux fruits qui, lorsque liée à du phosphore induirait une préférence du milieu pour les D.suzuki. Cette hypothèse nécessite l'étude de la composition exacte des milieux de fruits comme des milieux phosphore de notre expérience. 
La dernière hypothèse dont nous avons discuté est que les milieux riches en phosphores créent une saturation de l'air qui tromperait les mouches dans le choix de leur milieux de préférence. Toutefois cette hypothèse n'est pas soutenue par les heatmaps réalisés sur le nombre de pontes moyen par emplacement dans les boites de 12. Cette hypothèse, comme la précédente, pourra être testée avec une étude approfondie de la composition chimique des milieux. 


